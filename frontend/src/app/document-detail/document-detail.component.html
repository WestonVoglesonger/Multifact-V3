<div *ngIf="niId" class="bg-white shadow rounded p-6">
  <h2 class="text-2xl font-semibold mb-6 text-gray-800">
    Document #{{ niId }} Detail
  </h2>

  <!-- Loading Indicator -->
  <div *ngIf="loading" class="flex justify-center items-center mb-4">
    <div
      class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"
    ></div>
    <span class="ml-4 text-gray-600">Loading...</span>
  </div>

  <!-- Error Message -->
  <div *ngIf="error" class="text-red-500 mb-4">
    {{ error }}
  </div>

  <!-- Document Details -->
  <div *ngIf="!loading && detail">
    <!-- Editable Content -->
    <div class="mb-6">
      <label class="block text-sm font-medium text-gray-700 mb-2"
        >Content</label
      >
      <textarea
        class="w-full border border-gray-300 rounded p-3 focus:outline-none focus:border-blue-500"
        [(ngModel)]="editableContent"
        rows="5"
      ></textarea>
      <div class="flex space-x-2 mt-3">
        <button
          class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition duration-200"
          (click)="updateDocument()"
          [disabled]="loading || recompiling"
        >
          Save
        </button>
        <button
          class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition duration-200 flex items-center"
          (click)="recompileDocument()"
          [disabled]="loading || recompiling"
        >
          <span>Recompile</span>
          <div
            *ngIf="recompiling"
            class="ml-2 loader border-white h-4 w-4 border-2 border-t-2 rounded-full"
          ></div>
        </button>
      </div>
    </div>

    <!-- Tokens Section -->
    <div class="mb-6">
      <h3 class="text-xl font-semibold mb-4 text-gray-700">Tokens</h3>
      <div *ngIf="detail.tokens.length > 0; else noTokens">
        <div class="overflow-x-auto">
          <table class="min-w-full bg-gray-50 rounded-lg">
            <thead>
              <tr>
                <th class="py-2 px-4 border-b text-left text-gray-600">ID</th>
                <th class="py-2 px-4 border-b text-left text-gray-600">
                  Scene
                </th>
                <th class="py-2 px-4 border-b text-left text-gray-600">
                  Component
                </th>
                <th class="py-2 px-4 border-b text-left text-gray-600">Hash</th>
                <th class="py-2 px-4 border-b text-left text-gray-600">
                  Content
                </th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let t of detail.tokens" class="hover:bg-blue-50">
                <td class="py-2 px-4 border-b">{{ t.id }}</td>
                <td class="py-2 px-4 border-b">{{ t.scene_name || "-" }}</td>
                <td class="py-2 px-4 border-b">
                  {{ t.component_name || "-" }}
                </td>
                <td class="py-2 px-4 border-b truncate max-w-xs">
                  {{ t.hash }}
                </td>
                <td class="py-2 px-4 border-b">{{ t.content }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <ng-template #noTokens>
        <p class="text-gray-500">No tokens found.</p>
      </ng-template>
    </div>

    <!-- Artifacts Section -->
    <div class="mb-6">
      <h3 class="text-xl font-semibold mb-4 text-gray-700">Artifacts</h3>
      <div *ngIf="detail.artifacts.length > 0; else noArtifacts">
        <div class="overflow-x-auto">
          <table class="min-w-full bg-gray-50 rounded-lg">
            <thead>
              <tr>
                <th class="py-2 px-4 border-b text-left text-gray-600">ID</th>
                <th class="py-2 px-4 border-b text-left text-gray-600">
                  Token ID
                </th>
                <th class="py-2 px-4 border-b text-left text-gray-600">
                  Language
                </th>
                <th class="py-2 px-4 border-b text-left text-gray-600">
                  Framework
                </th>
                <th class="py-2 px-4 border-b text-left text-gray-600">
                  Valid
                </th>
                <th class="py-2 px-4 border-b text-left text-gray-600">
                  Cache Hit
                </th>
                <th class="py-2 px-4 border-b text-left text-gray-600">Code</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let a of detail.artifacts" class="hover:bg-blue-50">
                <td class="py-2 px-4 border-b">{{ a.id }}</td>
                <td class="py-2 px-4 border-b">{{ a.ni_token_id }}</td>
                <td class="py-2 px-4 border-b">{{ a.language }}</td>
                <td class="py-2 px-4 border-b">{{ a.framework }}</td>
                <td class="py-2 px-4 border-b">
                  <span
                    class="px-2 py-1 rounded text-xs font-semibold"
                    [ngClass]="{
                      'bg-green-100 text-green-800': a.valid,
                      'bg-red-100 text-red-800': !a.valid
                    }"
                  >
                    {{ a.valid ? "Yes" : "No" }}
                  </span>
                </td>
                <td class="py-2 px-4 border-b">
                  <span
                    class="px-2 py-1 rounded text-xs font-semibold"
                    [ngClass]="{
                      'bg-blue-100 text-blue-800': a.cache_hit,
                      'bg-gray-100 text-gray-800': !a.cache_hit
                    }"
                  >
                    {{ a.cache_hit ? "Hit" : "Miss" }}
                  </span>
                </td>
                <td class="py-2 px-4 border-b">
                  <pre
                    class="whitespace-pre-wrap text-sm text-gray-700 bg-gray-100 p-2 rounded"
                  >
  {{ a.code }}
                  </pre>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <ng-template #noArtifacts>
        <p class="text-gray-500">No artifacts compiled yet.</p>
      </ng-template>
    </div>
  </div>

  <style>
    .loader {
      border-top-color: #3498db;
      animation: spinner 1.5s linear infinite;
    }

    @keyframes spinner {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</div>
